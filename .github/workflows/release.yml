name: ğŸš€ Generar y publicar NuGet + Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'   # Se ejecuta cuando subas un tag como "v1.0.0-SI784"

permissions:
  contents: write
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ğŸ§© Restaurar dependencias
        run: dotnet restore MyMath/MyMath.sln

      - name: ğŸ§± Compilar soluciÃ³n
        run: dotnet build MyMath/MyMath.sln --configuration Release --no-restore

      # ğŸ“¦ Empaquetar la librerÃ­a con tu cÃ³digo de matrÃ­cula
      - name: ğŸ“¦ Generar paquete NuGet
        run: dotnet pack MyMath/Math.Lib/Math.Lib.csproj --configuration Release -p:PackageVersion=1.0.0-SI784 -o ./nupkg

      # ğŸ” Configurar autenticaciÃ³n con GitHub Packages
      - name: âš™ï¸ Crear configuraciÃ³n de NuGet con autenticaciÃ³n
        run: |
          mkdir -p ~/.nuget/NuGet
          cat > ~/.nuget/NuGet/NuGet.Config <<EOL
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <add key="github" value="https://nuget.pkg.github.com/dennisdhm7/index.json" />
            </packageSources>
            <packageSourceCredentials>
              <github>
                <add key="Username" value="dennisdhm7" />
                <add key="ClearTextPassword" value="${{ secrets.GH_PACKAGES_TOKEN }}" />
              </github>
            </packageSourceCredentials>
          </configuration>
          EOL
          cat ~/.nuget/NuGet/NuGet.Config

      # ğŸš€ Publicar el paquete en GitHub Packages
      - name: ğŸš€ Publicar paquete en GitHub Packages
        run: dotnet nuget push "./nupkg/*.nupkg" --source "github" --api-key ${{ secrets.GH_PACKAGES_TOKEN }} --skip-duplicate

      # ğŸ·ï¸ Crear release con el .nupkg adjunto
      - name: ğŸ·ï¸ Crear Release con artefacto NuGet
        uses: softprops/action-gh-release@v1
        with:
          files: ./nupkg/*.nupkg
          tag_name: v1.0.0-SI784
          name: "Release v1.0.0-SI784"
          body: |
            ğŸš€ **Release generado automÃ¡ticamente**
            - ğŸ“¦ Paquete: Math.Lib
            - ğŸ§‘ Alumno: Christian Dennis Hinojosa Mucho
            - ğŸ§¾ VersiÃ³n: 1.0.0-SI784
